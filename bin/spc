#!/usr/bin/env php
<?php

use SPC\ConsoleApplication;
use SPC\exception\ExceptionHandler;

require_once __DIR__ . '/../vendor/autoload.php';

// 防止 Micro 打包状态下不支持中文的显示（虽然这个项目目前好像没输出过中文？）
if (PHP_OS_FAMILY === 'Windows' && Phar::running()) {
    exec('CHCP 65001');
}

if (in_array('--docker', $_SERVER['argv'] ?? [], true)) {
    // Remove first argument as it point this file
    $arguments = $_SERVER['argv'];
    unset($arguments[0]);

    // Remove fake option used in pre-built binary
    foreach ($arguments as $key => $argument) {
        if ($argument === '--docker') {
            unset($arguments[$key]);

            break;
        }
    }

    try {
        $temporary = str_replace('spc.phar', 'bin/spc-docker', Phar::running(false));
        file_put_contents($temporary, file_get_contents(__DIR__ . '/spc-alpine-docker'));
        f_passthru('chmod +x ' . $temporary . ' && ' . $temporary . ' ' . implode(' ', $arguments) . ' && rm -f ' . $temporary);
    } catch (Exception $e) {
        pcntl_signal(SIGINT, SIG_IGN);

        ExceptionHandler::getInstance()->handle($e);
    }
} else {
    try {
        (new ConsoleApplication())->run();
    } catch (Exception $e) {
        ExceptionHandler::getInstance()->handle($e);
    }
}
